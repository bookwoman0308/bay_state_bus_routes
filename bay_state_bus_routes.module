<?php


/**
 * Implements hook_help()
 */
function bay_state_bus_routes_help($path, $arg) {
  switch ($path) {
  case "admin/help#bay_state_bus_routes":
    return '<p>' . t("Displays bus routes for MBTA.");
    break;
  }
}

/**
 * Implements hook_menu()
 */
function bay_state_bus_routes_menu() {

    $items = array();

    $items['bay-state'] = array(
      'title' => 'MBTA Routes and Schedules',
      'description' => 'Schedules from MBTA',
      'page callback' => 'bay_state_bus_routes_display',
      'access arguments' => array('access content'),
    );
    $items['bay-state/schedule/%'] = array(
      'title' => 'Route Schedule',
      'page callback' => 'bay_state_bus_routes_schedule_page',
      'access arguments' => array('access content'),
      'page arguments' => array(2),  //pass route_id
    );
    return $items;
  }



function bay_state_bus_routes_display() {

  $routes = array();
  $routes = _get_all_routes($routes);

  $output = '';

  if (empty($routes)) {
    $output = 'An error occurred with retrieving route data from the MBTA API. Please try back again later.';
  }

  else {
    $output = _render_route_markup($output, $routes);
  }

  $content['mbta_markup'] = array(
    '#type' => 'markup',
    '#markup' => $output,
  );
 
  return $content;
}


function _get_all_routes($routes) {

  //$route_id = 'Red';
  //$url = 'https://api-v3.mbta.com/schedules?filter[route]=' . $route_id . '/';
  //$url = 'https://api-v3.mbta.com/schedules?filter[route]=Red';

  $url = 'https://api-v3.mbta.com/routes/';

  //Use drupal_http_request instead of CURL!
  $options = array(
    'method' => 'GET',
    'headers' => array('Content-Type' => 'application/json'),
  );
  $response = drupal_http_request('https://api-v3.mbta.com/routes/', $options);

  if (($response->code == 200) && ($response->status_message == 'OK')) {
    $decoded_response = json_decode($response->data, true);

    $route_array = $decoded_response['data'];

    $route_attribute_array = array();
    foreach ($route_array as $key) {
      if (!$long_name || $long_name = ' ') {
        $long_name = $key['id'];
      }
      else {
        $long_name = $key['attributes']['long_name'];
     }
     $route_attribute_array[] = array(
       'type' => $key['attributes']['description'],
       'long_name' => $long_name,
       'bg_color' => $key['attributes']['color'],
       'text_color' => $key['attributes']['text_color'],
       'route_id' => $key['id'],
       );
    }
  }

  return $route_attribute_array;
}


function _render_route_markup($output, $route_attribute_array) {

  //Identify the transit types from the API call, i.e. Rapid Transit, Local Bus, Ferry, etc.
  $route_types = array_unique(array_column($route_attribute_array, 'type'));

  $output .= '<div class="route">';
  foreach ($route_types as $key => $value) {
    $output .= '<p style="font-size: 14px;"><strong>' . $value . '</strong></p>';
    foreach ($route_attribute_array as $row) {
      if ($row['type'] == $value) {
        $go_to = '/bay-state/schedule/' . $row['route_id'];   //send route_id to page callback
        $output .= '<p style="background-color:#' . $row['bg_color'] . '"><a style="color:#' . $row['text_color'] . '" href="' . $go_to . '">' . $row['long_name'] . '</a></p>';
      }
    }
  }

  $output .= '</div>';
  
  return $output;
}

function bay_state_bus_routes_schedule_page($route_id) {

  $form_var = drupal_get_form('bay_state_bus_routes_schedule_form', $route_id);

  return $form_var;

}

function bay_state_bus_routes_schedule_form($form, &$form_state, $route_id) {

  $output = '';

  //Make the API call to get the schedule for the specific route id
  //TODO

  $form = array();

  $form['route']['schedule'] = array(
     '#markup' => $output,
      );

  return $form;
}
